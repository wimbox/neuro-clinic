<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro-Clinic | لوحة إدارة العيادة</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/neuro-ui.css">
</head>

<body>

    <div class="neuro-container">
        <!-- Sidebar Navigation -->
        <aside class="neuro-sidebar">
            <div class="sidebar-logo">
                <i class="fa-solid fa-brain"></i>
                <span>Neuro-Clinic</span>
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-item active" data-view="dashboard">
                    <i class="fa-solid fa-house"></i>
                    <span>الرئيسية</span>
                </a>
                <a href="javascript:void(0)" class="nav-item" data-view="patients" id="btn-manage-patients">
                    <i class="fa-solid fa-users"></i>
                    <span>سجلات المرضى</span>
                </a>
                <a href="#" class="nav-item" data-view="appointments">
                    <i class="fa-solid fa-calendar-check"></i>
                    <span>جدول المواعيد</span>
                </a>
                <a href="javascript:void(0)" class="nav-item" data-view="settings" id="btn-settings">
                    <i class="fa-solid fa-gear"></i>
                    <span>الإعدادات</span>
                </a>
                <a href="queue-display.html" target="_blank" class="nav-item">
                    <i class="fa-solid fa-tv"></i>
                    <span>شاشة الانتظار</span>
                </a>
                <a href="javascript:void(0)" class="nav-item" data-view="templates" id="btn-templates">
                    <i class="fa-solid fa-file-medical"></i>
                    <span>مكتبة الروشتات</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="javascript:void(0)" class="nav-item logout-link" id="btn-logout"
                    onclick="window.authManager.logout()">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>خروج</span>
                </a>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="neuro-main">
            <div class="top-ticker-bar">
                <div class="ticker-content">
                    <div class="ticker-item">
                        <i class="fa-solid fa-user-doctor"
                            style="color: #fff; text-shadow: 0 0 10px var(--accent-blue);"></i>
                        <span style="color: #fff; font-weight: 800;">دكتور/ أحمد محمد أحمد خليل</span>
                        <i class="fa-solid fa-star-of-life separator-icon"></i>
                        <span>مدرس وإستشاري جراحات المخ والأعصاب والعمود الفقري - كلية الطب - جامعة الأسكندرية</span>
                        <i class="fa-solid fa-star-of-life separator-icon"></i>
                    </div>
                    <!-- Duplicate for seamless loop -->
                    <div class="ticker-item">
                        <i class="fa-solid fa-user-doctor"
                            style="color: #fff; text-shadow: 0 0 10px var(--accent-blue);"></i>
                        <span style="color: #fff; font-weight: 800;">دكتور/ أحمد محمد أحمد خليل</span>
                        <i class="fa-solid fa-star-of-life separator-icon"></i>
                        <span>مدرس وإستشاري جراحات المخ والأعصاب والعمود الفقري - كلية الطب - جامعة الأسكندرية</span>
                        <i class="fa-solid fa-star-of-life separator-icon"></i>
                    </div>
                </div>
            </div>

            <!-- Top Bar -->
            <header class="top-bar">
                <!-- Clinic Selector -->
                <div style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
                    <div
                        style="display: flex; align-items: center; gap: 10px; background: #1e293b; padding: 5px 12px; border-radius: 12px; border: 2px solid var(--accent-blue); box-shadow: 0 0 15px rgba(0, 234, 255, 0.1);">
                        <i class="fa-solid fa-hospital" style="color: var(--accent-blue); font-size: 1rem;"></i>
                        <select id="clinic-selector"
                            style="background: transparent; border: none; color: #00eaff; font-weight: 800; font-size: 0.95rem; padding: 5px; cursor: pointer; min-width: 140px; outline: none; font-family: 'Tajawal', sans-serif;">
                            <!-- Populated by JS -->
                        </select>
                        <button id="btn-confirm-clinic" title="تأكيد التبديل وتحديث البيانات"
                            style="background: var(--accent-blue); border: none; color: #000; width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                            <i class="fa-solid fa-check" style="font-size: 0.8rem; font-weight: 900;"></i>
                        </button>
                    </div>
                </div>

                <!-- Cloud Sync Sensor -->
                <div class="sync-sensor" id="sync-sensor" title="حالة الاتصال السحابي وسرعة الاستجابة">
                    <div class="sync-status-dot"></div>
                    <div class="sync-info">
                        <span class="sync-label">Cloud Sync</span>
                        <span class="sync-latency" id="sync-latency">---</span>
                    </div>
                    <button onclick="window.syncManager.triggerCloudSync()"
                        style="background:transparent; border:none; color:var(--text-secondary); cursor:pointer; padding:5px; margin-right:5px;">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>

                <div class="search-bar" style="position: relative;">
                    <i class="fa-solid fa-magnifying-glass" style="color: var(--text-secondary);"></i>
                    <input type="text" id="global-patient-search" placeholder="بحث سريع عن مريض...">
                    <div id="global-search-suggestions" class="autocomplete-suggestions"
                        style="display: none; position: absolute; top: 110%; left: 0; width: 100%; z-index: 1000;">
                    </div>
                </div>

                <!-- Shortcuts (Buttons with better harmony) -->
                <!-- Shortcuts (Aligned next to search) -->
                <div style="display: flex; align-items: center; gap: 10px; margin-right: 20px;">
                    <a href="editor.html" class="header-nav-btn" title="محرر الروشتات">
                        <i class="fa-solid fa-file-signature"></i>
                        <span>محرر الروشتات</span>
                    </a>
                    <a href="finance-manager.html" target="_blank" class="header-nav-btn" title="المدير المالي"
                        style="color: var(--accent-blue) !important;">
                        <i class="fa-solid fa-wallet"></i>
                        <span>المدير المالي</span>
                    </a>
                </div>

                <!-- Sound Toggle Button -->
                <button id="btn-toggle-sound" class="btn-sound-toggle" title="تبديل الصوت">
                    <i class="fa-solid fa-volume-high" id="sound-icon"></i>
                    <span id="sound-text" style="margin-right: 8px;">صوت</span>
                </button>
            </header>

            <!-- Dynamic Content Area -->
            <div id="main-content-view" class="view-container">
                <!-- Dashboard View (Default) -->
                <div id="view-dashboard">
                    <div class="stats-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Finance Manager Link Card (New) -->
                        <!-- Finance Manager Link Card Removed -->
                        <div class="stat-card" style="border-right: 5px solid #10b981;">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                <i class="fa-solid fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-patients-count" style="font-size: 1.5rem;">0</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">إجمالي المرضى</p>
                            </div>
                        </div>
                        <div class="stat-card" style="border-right: 5px solid #f59e0b;">
                            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                <i class="fa-solid fa-calendar-day"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-appointments-today" style="font-size: 1.5rem;">0</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">مواعيد اليوم</p>
                            </div>
                        </div>
                        <div class="stat-card" style="border-right: 5px solid #3b82f6;">
                            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                                <i class="fa-solid fa-hand-holding-dollar"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-income-total" style="font-size: 1.5rem;">0</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">إجمالي الإيرادات</p>
                            </div>
                        </div>
                        <div class="stat-card" style="border-right: 5px solid #ef4444;">
                            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                                <i class="fa-solid fa-receipt"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-expenses-total" style="font-size: 1.5rem;">0</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">إجمالي المصاريف</p>
                            </div>
                        </div>
                        <div class="stat-card" style="border-right: 5px solid #a855f7;">
                            <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-net-profit"
                                    style="font-size: 1.5rem; color: #fff; text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);">
                                    0</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">صافي الربح الحقيقي</p>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="section-header">
                            <h2>جدول مواعيد اليوم</h2>
                            <button class="btn-neuro" id="btn-quick-appointment">
                                <i class="fa-solid fa-plus"></i> حجز موعد جديد
                            </button>
                        </div>
                        <table class="neuro-table">
                            <thead>
                                <tr>
                                    <th>المريض</th>
                                    <th>الوقت</th>
                                    <th>نوع الحالة</th>
                                    <th>الحالة</th>
                                    <th>الإجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div
                                                style="width: 35px; height: 35px; border-radius: 10px; background: #0f172a; border: 1px solid var(--accent-blue); display:flex; align-items:center; justify-content:center; font-size:0.9rem; color: var(--accent-blue); box-shadow: 0 0 10px rgba(0, 234, 255, 0.2);">
                                                و</div>
                                            <span style="font-weight: 700; color: #fff;">--</span>
                                        </div>
                                    </td>
                                    <td>07:30 م</td>
                                    <td>متابعة عصبية</td>
                                    <td><span class="status-badge status-confirmed">مؤكد</span></td>
                                    <td>
                                        <button
                                            style="background: transparent; border: none; color: var(--accent-glow); cursor: pointer;">
                                            <i class="fa-solid fa-ellipsis-vertical"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- More rows placeholder -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Appointments View -->
                <div id="view-appointments" class="hidden">
                    <div class="data-card">
                        <div class="section-header">
                            <h2>سجل المواعيد المحجوزة</h2>
                            <button class="btn-neuro" id="btn-open-booking">
                                <i class="fa-solid fa-calendar-plus"></i> حجز موعد جديد
                            </button>
                        </div>
                        <table class="neuro-table">
                            <thead>
                                <tr>
                                    <th>المريض</th>
                                    <th>التاريخ والوقت</th>
                                    <th>نوع الخدمة</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Other views placeholders -->
                <!-- Patients Management View -->
                <div id="view-patients" class="hidden">
                    <div class="data-card">
                        <div class="section-header">
                            <h2 style="text-shadow: 0 0 15px rgba(0, 234, 255, 0.3);">إدارة سجلات المرضى</h2>
                            <button class="btn-neuro" id="btn-add-new-patient">
                                <i class="fa-solid fa-user-plus"></i> إضافة مريض جديد
                            </button>
                        </div>
                        <table class="neuro-table">
                            <thead>
                                <tr>
                                    <th>كود المريض</th>
                                    <th>اسم المريض</th>
                                    <th>العمر</th>
                                    <th>الهاتف</th>
                                    <th>آخر زيارة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="manage-patients-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Finance View -->
                <div id="view-finance" class="hidden">
                    <div class="data-card">
                        <div class="section-header">
                            <h2>القيود اليومية والحسابات</h2>
                            <div style="display: flex; gap: 10px;">
                                <a href="finance-manager.html" target="_blank" class="btn-neuro"
                                    style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 5px 15px;">
                                    <i class="fa-solid fa-square-arrow-up-right"></i> فتح المدير المالي
                                </a>
                                <button class="btn-neuro" id="btn-print-monthly-report"
                                    style="background: var(--accent-blue); color: #000; padding: 5px 15px;">
                                    <i class="fa-solid fa-print"></i> تقرير
                                </button>
                                <button class="btn-neuro" id="btn-add-expense"
                                    style="background: #ef4444; padding: 5px 15px;">
                                    <i class="fa-solid fa-minus-circle"></i> إضافة مصروف
                                </button>
                            </div>
                        </div>

                        <!-- Financial Charts Section -->
                        <div class="charts-grid"
                            style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div id="revenue-chart-container">
                                <!-- Revenue Line Chart will be rendered here -->
                            </div>
                            <div id="expense-pie-chart-container">
                                <!-- Expenses Pie Chart will be rendered here -->
                            </div>
                        </div>

                        <div id="financial-summary-container" style="margin-bottom: 30px;">
                            <!-- Financial Summary Cards -->
                        </div>
                        <table class="neuro-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>البيان</th>
                                    <th>النوع</th>
                                    <th>المبلغ</th>
                                    <th>المستفيد</th>
                                </tr>
                            </thead>
                            <tbody id="finance-table-body">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="hidden">
                    <!-- Dynamic settings content loaded via dashboardUI.loadSettingsView() -->
                </div>

                <!-- Prescription Templates View -->
                <div id="view-templates" class="hidden">
                    <div class="data-card">
                        <div class="section-header">
                            <h2><i class="fa-solid fa-file-medical"></i> مكتبة الروشتات الجاهزة</h2>
                            <button class="btn-neuro" id="btn-add-template">
                                <i class="fa-solid fa-plus"></i> قالب جديد
                            </button>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <input type="text" id="template-search" class="neuro-input" placeholder="بحث في القوالب..."
                                style="width: 100%; padding: 12px; background: #111827; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-size: 1rem;">
                        </div>

                        <div id="templates-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <!-- Templates will be dynamically inserted here -->
                        </div>

                        <div id="templates-empty" class="hidden"
                            style="text-align: center; padding: 60px 20px; color: #64748b;">
                            <i class="fa-solid fa-folder-open"
                                style="font-size: 4rem; opacity: 0.3; margin-bottom: 20px;"></i>
                            <p style="font-size: 1.2rem;">لا توجد قوالب محفوظة بعد</p>
                            <p style="opacity: 0.7;">انقر على "قالب جديد" لإنشاء أول قالب روشتة</p>
                        </div>
                    </div>
                </div>

            </div>
    </div>
    </main>
    </div>

    <!-- Modal: Book Appointment -->
    <div id="appointment-booking-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div class="modal-content"
            style="background: #1e293b; border: 2px solid #00eaff; border-radius: 24px; padding: 45px; width: 95%; display: grid; grid-template-columns: 1fr 0.8fr; gap: 45px; box-shadow: 0 0 60px rgba(0, 234, 255, 0.3); position: relative; max-width: 98vw;">
            <!-- Right side: Form -->
            <div>
                <h3
                    style="margin-bottom: 25px; color: #00eaff; font-size: 1.8rem; display: flex; align-items: center; gap: 15px;">
                    <i class="fa-solid fa-calendar-plus"></i> إضافة موعد جديد
                </h3>
                <form id="appointment-booking-form">
                    <div class="form-group" style="margin-bottom: 25px; position: relative;">
                        <label style="display: block; margin-bottom: 10px; color: #94a3b8; font-weight: 600;">اسم
                            المريض</label>
                        <input type="text" id="book-patient-name-appointment" class="neuro-input"
                            placeholder="ابحث عن مريض مسجل..." autocomplete="off"
                            style="width: 100%; padding: 15px; background: #111827; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-size: 1.1rem;">
                        <input type="hidden" id="book-patient-id">
                        <div id="appointment-name-suggestions" class="autocomplete-suggestions" style="display: none;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; margin-bottom: 25px; align-items: flex-end;">
                        <div class="form-group" style="flex: 0.4;">
                            <label style="display: block; margin-bottom: 10px; color: #94a3b8; font-weight: 600;">نوع
                                الخدمة</label>
                            <select id="book-service-appointment" class="form-control"
                                style="width: 100%; background: #0b1120; border: 2px solid rgba(0, 234, 255, 0.2); box-shadow: 0 0 15px rgba(0, 234, 255, 0.1); padding: 5px 10px; border-radius: 15px; color: #fff; outline: none; height: 60px; cursor: pointer; font-size: 18px; font-weight: 700;">
                                <option value="كشف جديد" style="background: #1e293b;">كشف جديد</option>
                                <option value="استشارة" style="background: #1e293b;">استشارة</option>
                                <option value="متابعة" style="background: #1e293b;">متابعة</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label style="display: block; margin-bottom: 10px; color: #94a3b8; font-weight: 600;">الموعد
                                (تاريخ ووقت)</label>
                            <div style="display: flex; gap: 15px; align-items: center; justify-content: space-between;">

                                <!-- Date Picker: Stylized Blocks (direction: rtl for Day/Month/Year) -->
                                <div
                                    style="flex: 1.2; display: flex; align-items: center; justify-content: center; gap: 8px; direction: rtl; background: rgba(0,0,0,0.3); border: 2px solid rgba(0, 234, 255, 0.1); border-radius: 15px; height: 60px; padding: 0 15px;">
                                    <select id="book-day-appointment"
                                        style="background: transparent; color: #00eaff; border: none; outline: none; font-size: 20px; font-weight: 900; width: 45px; cursor: pointer; text-align: center; font-family: 'Inter'; appearance: none;"></select>
                                    <span style="color: rgba(255,255,255,0.2); font-weight: 900;">/</span>
                                    <select id="book-month-appointment"
                                        style="background: transparent; color: #00eaff; border: none; outline: none; font-size: 20px; font-weight: 900; width: 45px; cursor: pointer; text-align: center; font-family: 'Inter'; appearance: none;"></select>
                                    <span style="color: rgba(255,255,255,0.2); font-weight: 900;">/</span>
                                    <select id="book-year-appointment"
                                        style="background: transparent; color: #00eaff; border: none; outline: none; font-size: 20px; font-weight: 900; width: 75px; cursor: pointer; text-align: center; font-family: 'Inter'; appearance: none;"></select>
                                    <i class="fa-solid fa-calendar-day"
                                        style="color: #00eaff; opacity: 0.5; font-size: 1.1rem; margin-right: 5px;"></i>
                                </div>

                                <!-- Time Picker: Stylized Blocks (direction: ltr for H:M AM/PM) -->
                                <div
                                    style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; direction: ltr; background: rgba(0,0,0,0.3); border: 2px solid rgba(0, 234, 255, 0.1); border-radius: 15px; height: 60px; padding: 0 15px;">
                                    <select id="book-hour-appointment"
                                        style="background: transparent; color: #00eaff; border: none; outline: none; font-size: 22px; font-weight: 900; width: 45px; cursor: pointer; text-align: center; font-family: 'Inter'; appearance: none;"></select>
                                    <span
                                        style="color: #00eaff; font-weight: 900; font-size: 22px; animation: flicker 2s infinite;">:</span>
                                    <select id="book-minute-appointment"
                                        style="background: transparent; color: #00eaff; border: none; outline: none; font-size: 22px; font-weight: 900; width: 45px; cursor: pointer; text-align: center; font-family: 'Inter'; appearance: none;"></select>

                                    <div
                                        style="background: #00eaff; padding: 4px 8px; border-radius: 8px; margin-left: 5px; box-shadow: 0 0 10px rgba(0, 234, 255, 0.3);">
                                        <select id="book-ampm-appointment"
                                            style="background: transparent; color: #000; border: none; outline: none; font-size: 16px; font-weight: 900; cursor: pointer; appearance: none;">
                                            <option value="AM">AM</option>
                                            <option value="PM">PM</option>
                                        </select>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div class="form-group">
                            <label
                                style="display: block; margin-bottom: 10px; color: #94a3b8; font-weight: 600;">التكلفة
                                الإجمالية (EGP)</label>
                            <input type="number" id="book-cost-appointment" class="form-control" placeholder="0.00"
                                style="width: 100%; background: #111827; border: 1px solid rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; color: #00eaff; font-weight: 900; font-family: 'Inter'; outline: none; font-size: 22px;">
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px; color: #94a3b8; font-weight: 600;">المبلغ
                                المدفوع (EGP)</label>
                            <input type="number" id="book-paid-appointment" class="form-control" placeholder="0.00"
                                style="width: 100%; background: #111827; border: 1px solid rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; color: #10b981; font-weight: 900; font-family: 'Inter'; outline: none; font-size: 22px;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn-neuro"
                            style="flex: 1; justify-content: center; height: 55px; background: #00eaff; color: #000; font-weight: 800; font-size: 1.1rem; border-radius: 12px; border: none; cursor: pointer; transition: all 0.3s;">حفظ
                            الموعد</button>
                        <button type="button" id="btn-close-appointment-booking" class="btn-neuro"
                            style="flex: 1; justify-content: center; height: 55px; background: transparent; color: #00eaff; border: 2px solid #00eaff; font-weight: 800; border-radius: 12px; cursor: pointer;">إلغاء</button>
                    </div>
                </form>
            </div>

            <!-- Left side: Clock Visual (Dynamic) -->
            <div
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.3); border-radius: 20px; padding: 40px; border: 2px solid rgba(0, 234, 255, 0.15); box-shadow: inset 0 0 20px rgba(0, 234, 255, 0.05);">

                <!-- Analog Clock -->
                <div class="neuro-clock-container">
                    <div class="neuro-clock-face">
                        <div class="clock-mark m1"></div>
                        <div class="clock-mark m2"></div>
                        <div class="clock-mark m3"></div>
                        <div class="clock-mark m4"></div>
                        <div class="clock-mark m5"></div>
                        <div class="clock-mark m6"></div>
                        <div class="clock-mark m7"></div>
                        <div class="clock-mark m8"></div>
                        <div class="clock-mark m9"></div>
                        <div class="clock-mark m10"></div>
                        <div class="clock-mark m11"></div>
                        <div class="clock-mark m12"></div>
                        <div class="clock-hand hour-hand" id="analog-hour"></div>
                        <div class="clock-hand minute-hand" id="analog-minute"></div>
                        <div class="clock-hand second-hand" id="analog-second"></div>
                        <div class="clock-center"></div>
                    </div>
                </div>

                <div id="modal-digital-clock" style="text-align: center; margin-bottom: 15px;">
                    <div id="modal-clock-time"
                        style="font-size: 2.5rem; font-weight: 900; font-family: 'Inter', sans-serif; display: flex; gap: 10px; justify-content: center; align-items: center; direction: ltr;">
                        <!-- Hours -->
                        <div
                            style="background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); min-width: 65px;">
                            <span id="digital-h"
                                style="color: #ffffff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);">00</span>
                        </div>
                        <span style="color: rgba(255,255,255,0.2); font-size: 1.5rem;">:</span>
                        <!-- Minutes -->
                        <div
                            style="background: rgba(0, 234, 255, 0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(0, 234, 255, 0.2); min-width: 65px;">
                            <span id="digital-m"
                                style="color: #00eaff; text-shadow: 0 0 15px rgba(0, 234, 255, 0.4);">00</span>
                        </div>
                        <span style="color: rgba(255,255,255,0.2); font-size: 1.5rem;">:</span>
                        <!-- Seconds -->
                        <div
                            style="background: rgba(255, 62, 62, 0.05); padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(255, 62, 62, 0.2); min-width: 65px;">
                            <span id="digital-s"
                                style="color: #ff3e3e; text-shadow: 0 0 15px rgba(255, 62, 62, 0.4);">00</span>
                        </div>
                        <!-- AM/PM -->
                        <div
                            style="margin-left: 10px; background: rgba(148, 163, 184, 0.1); padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.1);">
                            <span id="digital-ampm"
                                style="font-size: 0.9rem; color: #94a3b8; font-weight: 800; text-transform: uppercase;">--</span>
                        </div>
                    </div>
                </div>

                <div id="modal-clock-date"
                    style="background: rgba(0, 234, 255, 0.1); padding: 8px 15px; border-radius: 10px; color: #fff; font-size: 0.95rem; font-weight: 600; border: 1px solid rgba(0, 234, 255, 0.2);">
                    --/--/----
                </div>

                <p
                    style="text-align: center; color: #64748b; font-size: 0.85rem; line-height: 1.6; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                    <i class="fa-solid fa-circle-info" style="margin-left: 5px;"></i> تأكد من مطابقة الوقت مع جدول
                    العيادة.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal: Add New Patient (Optimized Size) -->
    <div id="booking-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(12px);">
        <div class="modal-content"
            style="background: #1e293b; border: 2px solid #00eaff; border-radius: 25px; padding: 35px 55px; width: 850px; box-shadow: 0 0 50px rgba(0, 234, 255, 0.3); position: relative; max-width: 95vw;">

            <h3
                style="margin-bottom: 20px; color: #00eaff; font-size: 1.6rem; display: flex; align-items: center; justify-content: flex-start; gap: 15px; font-weight: 800; text-shadow: 0 0 15px rgba(0, 234, 255, 0.2);">
                <i class="fa-solid fa-user-plus" style="font-size: 1.8rem;"></i> إضافة مريض جديد
            </h3>

            <form id="booking-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">اسم
                        المريض رباعياً <span style="color: #ef4444;">*</span></label>
                    <div class="triple-name-container" style="display: flex; gap: 8px; direction: rtl; width: 100%;">
                        <input type="text" id="book-name-1" class="form-control triple-input" placeholder="الأول"
                            required
                            style="width: 20%; text-align: center; background: #0b1120; border: 2px solid rgba(0, 234, 255, 0.2); padding: 12px 5px; border-radius: 10px; color: white; outline: none; transition: all 0.3s; font-size: 1.1rem; font-weight: 600;">
                        <input type="text" id="book-name-2" class="form-control triple-input" placeholder="الثاني"
                            required
                            style="width: 20%; text-align: center; background: #0b1120; border: 2px solid rgba(0, 234, 255, 0.2); padding: 12px 5px; border-radius: 10px; color: white; outline: none; transition: all 0.3s; font-size: 1.1rem; font-weight: 600;">
                        <input type="text" id="book-name-3" class="form-control triple-input" placeholder="الثالث"
                            required
                            style="width: 20%; text-align: center; background: #0b1120; border: 2px solid rgba(0, 234, 255, 0.2); padding: 12px 5px; border-radius: 10px; color: white; outline: none; transition: all 0.3s; font-size: 1.1rem; font-weight: 600;">
                        <input type="text" id="book-name-4" class="form-control triple-input" placeholder="اللقب/الرابع"
                            style="width: 20%; text-align: center; background: rgba(0, 234, 255, 0.03); border: 2px solid rgba(0, 234, 255, 0.1); padding: 12px 5px; border-radius: 10px; color: white; outline: none; transition: all 0.3s; font-size: 1.1rem; font-weight: 600;">
                    </div>
                </div>

                <div style="display: flex; gap: 30px; margin-bottom: 20px; justify-content: flex-start;">
                    <div class="form-group" style="width: 200px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">النوع</label>
                        <select id="book-gender" class="form-control"
                            style="width: 100%; background: #0b1120; border: 2px solid rgba(0, 234, 255, 0.2); padding: 12px; border-radius: 10px; color: white; outline: none; appearance: none; cursor:pointer; font-size: 1.1rem; font-weight: 600; text-align: center;">
                            <option value="ذكر">ذكر</option>
                            <option value="أنثى">أنثى</option>
                        </select>
                    </div>
                    <div class="form-group" style="width: 150px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">السن</label>
                        <input type="text" id="book-age" class="form-control"
                            style="width: 100%; background: #0b1120; border: 2px solid rgba(255, 255, 255, 0.08); padding: 12px; border-radius: 10px; color: white; outline: none; font-size: 1.1rem; font-weight: 600; text-align: center;"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">رقم
                        الهاتف <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="book-phone" class="form-control"
                        style="width: 50%; background: #0b1120; border: 2px solid rgba(255, 255, 255, 0.08); padding: 12px; border-radius: 10px; color: #00eaff; outline: none; font-size: 1.3rem; font-weight: 800; letter-spacing: 1px;"
                        required minlength="7" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">حساسية
                        تجاه أدوية معينة</label>
                    <input type="text" id="book-allergies" class="form-control"
                        style="width: 80%; background: #0b1120; border: 2px solid rgba(255, 255, 255, 0.08); padding: 12px; border-radius: 10px; color: #f87171; outline: none; font-size: 1.1rem; font-weight: 600;"
                        placeholder="مثال: البنسلين، السلفا...">
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: #fff; font-weight: 700; font-size: 1.1rem; text-align: right;">ملاحظات
                        دائمة</label>
                    <textarea id="book-notes" class="form-control"
                        style="width: 100%; background: #0b1120; border: 2px solid rgba(255, 255, 255, 0.08); padding: 12px; border-radius: 10px; color: white; outline: none; height: 70px; resize: none; font-size: 1.1rem; font-weight: 500;"></textarea>
                </div>

                <div
                    style="display: flex; flex-direction: row-reverse; gap: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                    <button type="submit"
                        style="width: 250px; height: 55px; background: #00eaff; color: #000; font-weight: 900; font-size: 1.2rem; border-radius: 12px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 20px rgba(0, 234, 255, 0.2);">حفظ
                        المريض</button>
                    <button type="button" id="btn-close-booking"
                        style="width: 150px; height: 55px; background: #0b1120; color: #00eaff; border: 2px solid #00eaff; font-weight: 900; font-size: 1.2rem; border-radius: 12px; cursor: pointer;">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Patient Medical File -->
    <div id="patient-file-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div class="modal-content"
            style="background: #1e293b; border: 2px solid #00eaff; border-radius: 25px; padding: 30px 50px; width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 60px rgba(0, 234, 255, 0.3); max-width: 95vw;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid rgba(0, 234, 255, 0.15); padding-bottom: 20px;">
                <div>
                    <h2 id="file-patient-name"
                        style="font-size: 2.2rem; color: #fff; text-shadow: 0 0 15px rgba(0, 234, 255, 0.4); font-weight: 900;">
                        اسم المريض
                    </h2>
                    <p id="file-patient-info"
                        style="color: #94a3b8; margin-top: 5px; font-size: 1.1rem; font-weight: 600;">ذكر، 35 سنة |
                        0123456789</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-neuro" id="btn-file-start-prescription"
                        style="background: #10b981; height: 50px; padding: 0 25px; font-size: 1.1rem;">
                        <i class="fa-solid fa-file-medical"></i> بدء روشتة
                    </button>
                    <button class="btn-neuro" id="btn-close-file"
                        style="background: #374151; height: 50px; padding: 0 25px; font-size: 1.1rem;">إغلاق</button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="data-card" style="background: rgba(0,0,0,0.15); padding: 25px; border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent-blue); font-size: 1.4rem; font-weight: 800;"><i
                            class="fa-solid fa-user-pen"></i>
                        تعديل البيانات</h3>
                    <form id="edit-patient-form">
                        <input type="hidden" id="edit-p-id">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label
                                style="color: #fff; font-size: 1rem; display:block; margin-bottom:10px; font-weight: 700;">التعديل
                                الرباعي للاسم <span style="color: #ef4444;">*</span></label>
                            <div class="triple-name-container"
                                style="display: flex; gap: 8px; direction: rtl; width: 100%;">
                                <input type="text" id="edit-name-1" class="form-control triple-input"
                                    placeholder="الأول" required
                                    style="width: 23%; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid var(--glass-border); padding: 10px 5px; border-radius: 10px; color: white; outline: none; font-size: 1.05rem;">
                                <input type="text" id="edit-name-2" class="form-control triple-input"
                                    placeholder="الثاني" required
                                    style="width: 23%; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid var(--glass-border); padding: 10px 5px; border-radius: 10px; color: white; outline: none; font-size: 1.05rem;">
                                <input type="text" id="edit-name-3" class="form-control triple-input"
                                    placeholder="الثالث" required
                                    style="width: 23%; text-align: center; background: rgba(0,0,0,0.3); border: 2px solid var(--glass-border); padding: 10px 5px; border-radius: 10px; color: white; outline: none; font-size: 1.05rem;">
                                <input type="text" id="edit-name-4" class="form-control triple-input"
                                    placeholder="الرابع"
                                    style="width: 23%; text-align: center; background: rgba(255,255,255,0.02); border: 2px solid var(--glass-border); padding: 10px 5px; border-radius: 10px; color: white; outline: none; font-size: 1.05rem;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group" style="width: 100px;">
                                <label
                                    style="color: #fff; font-size: 1rem; font-weight: 700; margin-bottom: 8px; display: block;">العمر</label>
                                <input type="number" id="edit-p-age" class="form-control"
                                    style="width: 100%; background: #111827; border: 2px solid rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 10px; color: white; font-size: 1.05rem; text-align: center;">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label
                                    style="color: #fff; font-size: 1rem; font-weight: 700; margin-bottom: 8px; display: block;">الهاتف
                                    <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="edit-p-phone" class="form-control"
                                    style="width: 100%; background: rgba(0,0,0,0.2); border: 2px solid var(--glass-border); padding: 10px; border-radius: 10px; color: #00eaff; font-size: 1.2rem; font-weight: 800;"
                                    required minlength="7" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                            </div>
                        </div>
                        <div
                            style="display: flex; gap: 12px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px;">
                            <button type="submit" class="btn-neuro"
                                style="flex: 1.5; justify-content: center; height: 50px; font-size: 1.1rem;">حفظ
                                التعديلات</button>
                            <button type="button" id="btn-delete-patient" class="btn-neuro"
                                style="background: #ef4444; flex: 0.5; justify-content: center; height: 45px; padding: 0 15px;">
                                <i class="fa-solid fa-trash" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="data-card" style="background: rgba(0,0,0,0.15); padding: 25px; border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; color: #10b981; font-size: 1.4rem; font-weight: 800;"><i
                            class="fa-solid fa-file-invoice-dollar"></i> كشف
                        حساب المريض</h3>
                    <div
                        style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid rgba(16,185,129,0.2);">
                        <span style="color: #94a3b8; font-size: 1rem; font-weight: 600;">الرصيد:</span>
                        <span id="patient-ledger-balance"
                            style="font-size: 1.8rem; font-weight: 900; color: #10b981; margin-right: 15px;">0
                            EGP</span>
                    </div>
                    <div id="patient-transactions-list" style="max-height: 200px; overflow-y: auto;"></div>
                    <div style="margin-top: 20px; display: flex; gap: 12px;">
                        <input type="number" id="add-p-income-amount" placeholder="مبلغ كشف..."
                            style="flex: 1; background: #0b1120; border: 2px solid var(--glass-border); padding: 10px; border-radius: 10px; color: white; outline: none; font-size: 1.1rem; font-weight: 700;">
                        <button class="btn-neuro" id="btn-add-p-income"
                            style="background: #10b981; height: 45px; padding: 0 20px; font-size: 0.9rem;">إضافة</button>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div class="data-card"
                style="background: rgba(0,0,0,0.15); padding: 25px; border-radius: 20px; margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #00eaff; font-size: 1.4rem; font-weight: 800;">
                        <i class="fa-solid fa-folder-open"></i> أرشيف المستندات والأشعة
                    </h3>
                    <button class="btn-neuro" id="btn-upload-doc" style="background: #3b82f6; padding: 8px 20px;">
                        <i class="fa-solid fa-cloud-arrow-up"></i> رفع ملف
                    </button>
                    <input type="file" id="doc-file-input" hidden accept="image/*,.pdf">
                </div>

                <div id="patient-docs-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    <!-- Documents will be rendered here -->
                    <div style="text-align: center; color: #64748b; padding: 20px; grid-column: 1/-1;">
                        لا توجد مستندات محفوظة لهذا المريض.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDKs (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="scripts/firebase-config.js"></script>

    <script src="scripts/sound-manager.js"></script>
    <script src="scripts/sync-manager.js"></script>
    <script src="scripts/patients.js"></script>
    <script src="scripts/appointments.js"></script>
    <script src="scripts/queue-manager.js"></script>
    <script src="scripts/prescription-templates.js"></script>
    <script src="scripts/templates-ui.js"></script>
    <script src="scripts/navigation.js"></script>
    <script src="scripts/financial-charts.js"></script>
    <script src="scripts/patient-documents.js"></script>
    <script src="scripts/auth-manager.js"></script>
    <script src="scripts/clinic-manager.js"></script>
    <script src="scripts/dashboard-ui.js"></script>
    <script src="scripts/patient-file-ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.authManager) window.authManager.init();

            // Attempt to pull latest data from cloud on start
            if (window.syncManager) {
                const success = await window.syncManager.pullFromCloud();
                if (success) {
                    console.log("Startup: Data synced from cloud.");
                    // Refresh UI if necessary
                    if (window.dashboardUI) window.dashboardUI.updateStats();
                }
            }
        });

        // Cloud Sync UI Controller
        window.addEventListener('syncStatusChanged', (e) => {
            const { status, latency } = e.detail;
            const sensor = document.getElementById('sync-sensor');
            const latencyEl = document.getElementById('sync-latency');
            if (!sensor || !latencyEl) return;

            // Update classes
            sensor.classList.remove('online', 'syncing', 'error');
            if (status !== 'offline') sensor.classList.add(status);

            // Update text
            if (status === 'syncing') {
                latencyEl.textContent = 'Syncing...';
            } else if (latency > 0) {
                latencyEl.textContent = `${latency}ms`;
            } else if (status === 'error') {
                latencyEl.textContent = 'Error';
            } else {
                latencyEl.textContent = 'Offline';
            }
        });
    </script>
</body>


</html>